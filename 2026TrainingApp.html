<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultra Training Companion</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & DOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f1f5f9; }
        /* Custom Scrollbar for the list */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- ICONS ---
        const Icon = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Activity = () => <Icon><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></Icon>;
        const Calendar = () => <Icon><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></Icon>;
        const CheckCircle = () => <Icon><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></Icon>;
        const AlertTriangle = () => <Icon><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></Icon>;
        const Save = () => <Icon><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></Icon>;
        const Share2 = () => <Icon><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></Icon>;
        const RefreshCw = () => <Icon><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></Icon>;
        const FileUp = () => <Icon><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 12v6"/><path d="m9 15 3-3 3 3"/></Icon>;
        const Download = () => <Icon><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></Icon>;
        const Dumbbell = () => <Icon><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m2 6 4-4"/><path d="m3 10 7-7"/><path d="m14 21 7-7"/></Icon>;

        // --- DEFAULT TEMPLATE (If no data found) ---
        const EMPTY_PLAN = [
            { week: 1, dates: "Week 1", phase: "Intro", vol: 30, vert: 0, focus: "Setup", strength: "Mobility", type: "Base", status: "pending" }
        ];

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-slate-200 p-4 ${className}`}>{children}</div>
        );

        const App = () => {
            const [weeks, setWeeks] = useState(EMPTY_PLAN);
            const [currentWeekIndex, setCurrentWeekIndex] = useState(0);
            const [selectedWeek, setSelectedWeek] = useState(null);
            const [isEditMode, setIsEditMode] = useState(false);
            const [isImportMode, setIsImportMode] = useState(false);
            const [importText, setImportText] = useState('');
            const [actuals, setActuals] = useState({ vol: 0, vert: 0, notes: '', difficulty: 3, outcome: 'Completed' });
            
            // --- PERSISTENCE ---
            useEffect(() => {
                const saved = localStorage.getItem('ultraPlan_universal');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if(parsed && Array.isArray(parsed) && parsed.length > 0) setWeeks(parsed);
                    } catch(e) { console.error("Error loading save", e); }
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('ultraPlan_universal', JSON.stringify(weeks));
            }, [weeks]);

            // --- ACTIONS ---

            const handleSaveLog = () => {
                const newWeeks = [...weeks];
                const week = newWeeks[selectedWeek];
                
                week.actualVol = parseInt(actuals.vol) || 0;
                week.actualVert = parseInt(actuals.vert) || 0;
                week.notes = actuals.notes;
                week.difficulty = actuals.difficulty;
                week.status = actuals.outcome;

                // Auto-adjust logic for injuries
                if (actuals.outcome === 'Injury') {
                    const factor = 0.5;
                    if (selectedWeek + 1 < newWeeks.length) { newWeeks[selectedWeek + 1].vol = Math.round(newWeeks[selectedWeek + 1].vol * factor); newWeeks[selectedWeek + 1].adjusted = true; }
                    if (selectedWeek + 2 < newWeeks.length) { newWeeks[selectedWeek + 2].vol = Math.round(newWeeks[selectedWeek + 2].vol * factor); newWeeks[selectedWeek + 2].adjusted = true; }
                }

                setWeeks(newWeeks);
                setIsEditMode(false);
                
                // Auto-advance current week if completing the active one
                if (selectedWeek === currentWeekIndex && currentWeekIndex < weeks.length - 1) {
                    setCurrentWeekIndex(currentWeekIndex + 1);
                }
            };

            const handleImportPlan = () => {
                try {
                    const parsed = JSON.parse(importText);
                    if (!Array.isArray(parsed) || parsed.length === 0) throw new Error("Invalid format");
                    if (!parsed[0].hasOwnProperty('week') || !parsed[0].hasOwnProperty('vol')) throw new Error("Invalid structure");

                    if (window.confirm(`Found plan with ${parsed.length} weeks. This will overwrite your current schedule. Proceed?`)) {
                        setWeeks(parsed);
                        setCurrentWeekIndex(0); // Reset to start
                        setIsImportMode(false);
                        setImportText('');
                    }
                } catch (e) {
                    alert("Invalid JSON. Please ensure you copied the code block exactly from the AI Gem.");
                }
            };

            const handleExportPlan = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(weeks, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "ultra_training_plan.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            const generateCoachReport = () => {
                const history = weeks.filter(w => w.status !== 'pending').map(w => 
                    `W${w.week}: Plan ${w.vol}km, Actual ${w.actualVol || 0}km. Status: ${w.status}. Diff: ${w.difficulty}/5. Notes: ${w.notes || ''}`
                ).join('\n');
                
                const nextWeeks = weeks.slice(currentWeekIndex, currentWeekIndex + 4).map(w =>
                    `Upcoming W${w.week}: Plan ${w.vol}km, Focus: ${w.focus}`
                ).join('\n');

                const prompt = `Status Report for Coach:\n\n-- HISTORY --\n${history || "No history yet."}\n\n-- UPCOMING --\n${nextWeeks}\n\nINSTRUCTIONS: Please analyze my progress. If adjustments are needed, or if I am asking for a NEW yearly plan, provide the Output as a JSON array representing the schedule so I can import it.`;
                
                const textArea = document.createElement("textarea");
                textArea.value = prompt;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert("Report copied! Paste this into your 'Ultra Coach' Gem.");
                } catch (err) {
                    alert("Copy failed. Please manually copy context.");
                }
                document.body.removeChild(textArea);
            };

            const openLogModal = (index) => {
                setSelectedWeek(index);
                const week = weeks[index];
                setActuals({
                    vol: week.actualVol || week.vol,
                    vert: week.actualVert || week.vert,
                    notes: week.notes || '',
                    difficulty: week.difficulty || 3,
                    outcome: week.status === 'pending' ? 'Completed' : week.status
                });
                setIsEditMode(true);
            };

            const getTypeStyle = (type) => {
                const styles = {
                    'Race_A': 'border-l-4 border-yellow-500 bg-yellow-50',
                    'Race': 'border-l-4 border-amber-300 bg-amber-50',
                    'Peak': 'border-l-4 border-purple-500 bg-purple-50',
                    'Recovery': 'border-l-4 border-green-400 bg-green-50',
                    'Taper': 'border-l-4 border-teal-400 bg-teal-50',
                    'Base': 'border-l-4 border-blue-400',
                    'Build': 'border-l-4 border-indigo-400'
                };
                return styles[type] || 'border-l-4 border-gray-300';
            };

            const getStatusColor = (status) => {
                const colors = {
                    'Completed': 'bg-green-100 text-green-800',
                    'Missed': 'bg-red-100 text-red-800',
                    'Injury': 'bg-orange-100 text-orange-800',
                    'Partial': 'bg-yellow-100 text-yellow-800',
                    'pending': 'bg-slate-100 text-slate-500'
                };
                return colors[status] || colors['pending'];
            };

            // Stats
            const totalPlanned = useMemo(() => weeks.reduce((acc, w) => acc + w.vol, 0), [weeks]);
            const totalDone = useMemo(() => weeks.reduce((acc, w) => acc + (w.actualVol || 0), 0), [weeks]);
            const completionRate = currentWeekIndex > 0 ? Math.round((weeks.slice(0, currentWeekIndex).filter(w => w.status === 'Completed').length / currentWeekIndex) * 100) : 100;

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-4xl mx-auto space-y-6">
                    
                    {/* Header & Actions */}
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                        <div>
                            <h1 className="text-2xl font-bold text-slate-900 flex items-center gap-2">
                                <Activity /> Ultra Companion
                            </h1>
                            <p className="text-slate-500 text-sm">Fernando Moitinho | Finish under Cutoff</p>
                        </div>
                        <div className="flex flex-wrap gap-2">
                            <button onClick={handleExportPlan} className="flex items-center gap-2 px-3 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 text-sm font-medium border border-slate-200" title="Backup Plan">
                                <Download /> Export
                            </button>
                            <button onClick={() => setIsImportMode(true)} className="flex items-center gap-2 px-3 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 text-sm font-medium border border-slate-200">
                                <FileUp /> Import
                            </button>
                            <button onClick={generateCoachReport} className="flex items-center gap-2 px-3 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 text-sm font-medium shadow-sm">
                                <Share2 /> Consult Gem
                            </button>
                        </div>
                    </div>

                    {/* Stats Dashboard */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <Card>
                            <div className="text-slate-500 text-xs uppercase font-bold mb-1">Current Week</div>
                            <div className="text-2xl font-bold text-blue-600">{weeks[currentWeekIndex]?.week || '-'}</div>
                            <div className="text-xs text-slate-400 truncate">{weeks[currentWeekIndex]?.dates || '-'}</div>
                        </Card>
                        <Card>
                            <div className="text-slate-500 text-xs uppercase font-bold mb-1">Target</div>
                            <div className="text-2xl font-bold text-slate-800">{weeks[currentWeekIndex]?.vol || 0}<span className="text-sm font-normal text-slate-400">km</span></div>
                            <div className="text-xs text-slate-500">{weeks[currentWeekIndex]?.vert || 0}m Vert</div>
                        </Card>
                        <Card>
                            <div className="text-slate-500 text-xs uppercase font-bold mb-1">Total Volume</div>
                            <div className="text-2xl font-bold text-emerald-600">{totalDone}</div>
                            <div className="text-xs text-slate-400">of {totalPlanned}km</div>
                        </Card>
                        <Card>
                            <div className="text-slate-500 text-xs uppercase font-bold mb-1">Consistency</div>
                            <div className="text-2xl font-bold text-purple-600">{completionRate}%</div>
                            <div className="text-xs text-slate-400">Completion</div>
                        </Card>
                    </div>

                    {/* Active Week Action Card */}
                    <Card className="border-blue-200 bg-blue-50/50">
                        <div className="flex justify-between items-start mb-4">
                            <div>
                                <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                    Focus: {weeks[currentWeekIndex]?.focus}
                                </h2>
                                <p className="text-sm text-slate-600 mt-1">
                                    {weeks[currentWeekIndex]?.phase} • {weeks[currentWeekIndex]?.dates}
                                </p>
                            </div>
                            <button onClick={() => openLogModal(currentWeekIndex)} className="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-sm hover:bg-blue-700 font-medium text-sm flex items-center gap-2">
                                <CheckCircle /> Log Week
                            </button>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div className="bg-white p-3 rounded-lg border border-blue-100">
                                <span className="block text-xs font-bold text-slate-400 uppercase mb-1">Target</span>
                                <div className="font-semibold text-slate-700">{weeks[currentWeekIndex]?.vol} km / {weeks[currentWeekIndex]?.vert} m</div>
                            </div>
                            <div className="bg-white p-3 rounded-lg border border-blue-100">
                                <span className="block text-xs font-bold text-slate-400 uppercase mb-1">Type</span>
                                <div className="font-semibold text-slate-700">{weeks[currentWeekIndex]?.type}</div>
                            </div>
                        </div>
                    </Card>

                    {/* Full Schedule List */}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div className="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                            <h3 className="font-bold text-slate-700 flex items-center gap-2"><Calendar /> Schedule</h3>
                            <div className="text-xs text-slate-500">Tap to edit history</div>
                        </div>
                        <div className="max-h-[500px] overflow-y-auto custom-scroll">
                            {weeks.map((week, idx) => (
                                <div key={idx} onClick={() => openLogModal(idx)} className={`p-3 border-b border-slate-50 hover:bg-slate-50 cursor-pointer transition-colors flex items-center justify-between gap-4 ${getTypeStyle(week.type)} ${idx === currentWeekIndex ? 'bg-blue-50' : ''}`}>
                                    <div className="flex-1">
                                        <div className="flex items-center gap-2 mb-1">
                                            <span className="text-xs font-bold text-slate-400 w-8">W{week.week}</span>
                                            <span className={`text-xs px-2 py-0.5 rounded-full font-medium ${getStatusColor(week.status)}`}>
                                                {week.status === 'pending' ? week.dates : week.status}
                                            </span>
                                            {week.adjusted && <span className="text-xs text-orange-500 flex items-center gap-1"><RefreshCw /> Adj</span>}
                                        </div>
                                        <div className="font-semibold text-sm text-slate-800">{week.focus}</div>
                                        <div className="text-xs text-slate-500 mt-1 flex items-center gap-1">
                                            <span className="font-semibold">Strength:</span> {week.strength || (week.phase.includes('Strength') ? 'Heavy Lifts' : 'Maintenance')}
                                        </div>
                                    </div>
                                    <div className="text-right min-w-[80px]">
                                        <div className="font-bold text-slate-700 text-sm">{week.actualVol || week.vol} km</div>
                                        <div className="text-xs text-slate-500 font-medium">{week.vert || 0}m+</div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Import Modal */}
                    {isImportMode && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden">
                                <div className="p-4 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
                                    <h3 className="font-bold text-slate-800">Import Plan from Gem</h3>
                                    <button onClick={() => setIsImportMode(false)} className="text-slate-400 hover:text-slate-600">✕</button>
                                </div>
                                <div className="p-6">
                                    <p className="text-sm text-slate-600 mb-2">Paste the JSON code block from your Ultra Coach Gem here:</p>
                                    <textarea value={importText} onChange={(e) => setImportText(e.target.value)} className="w-full p-3 border border-slate-300 rounded-lg h-40 font-mono text-xs focus:ring-2 focus:ring-blue-500 outline-none mb-4" placeholder='[ { "week": 1, "vol": 30 ... } ]'></textarea>
                                    <button onClick={handleImportPlan} className="w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                                        <FileUp /> Import & Overwrite
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Log Modal */}
                    {isEditMode && selectedWeek !== null && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
                                <div className="p-4 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
                                    <h3 className="font-bold text-slate-800">Log Week {weeks[selectedWeek].week}</h3>
                                    <button onClick={() => setIsEditMode(false)} className="text-slate-400 hover:text-slate-600">✕</button>
                                </div>
                                <div className="p-6 space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Outcome</label>
                                        <div className="grid grid-cols-2 gap-2">
                                            {['Completed', 'Partial', 'Missed', 'Injury'].map(opt => (
                                                <button key={opt} onClick={() => setActuals({...actuals, outcome: opt})} className={`py-2 px-3 text-sm rounded-lg border ${actuals.outcome === opt ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`}>{opt}</button>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Dist (km)</label>
                                            <input type="number" value={actuals.vol} onChange={(e) => setActuals({...actuals, vol: e.target.value})} className="w-full p-2 border border-slate-300 rounded-lg" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Vert (m)</label>
                                            <input type="number" value={actuals.vert} onChange={(e) => setActuals({...actuals, vert: e.target.value})} className="w-full p-2 border border-slate-300 rounded-lg" />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Difficulty (1-5)</label>
                                        <div className="flex justify-between gap-1">
                                            {[1,2,3,4,5].map(n => (
                                                <button key={n} onClick={() => setActuals({...actuals, difficulty: n})} className={`flex-1 py-2 rounded-lg text-sm font-bold ${actuals.difficulty === n ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-400'}`}>{n}</button>
                                            ))}
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Notes</label>
                                        <textarea value={actuals.notes} onChange={(e) => setActuals({...actuals, notes: e.target.value})} className="w-full p-2 border border-slate-300 rounded-lg h-20 text-sm" placeholder="How did it feel?"></textarea>
                                    </div>
                                    {actuals.outcome === 'Injury' && (
                                        <div className="p-3 bg-red-50 text-red-700 text-xs rounded-lg flex items-start gap-2">
                                            <AlertTriangle /> <span>Volume for next 2 weeks will decrease by 50%.</span>
                                        </div>
                                    )}
                                    <button onClick={handleSaveLog} className="w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                                        <Save /> Save Log
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
